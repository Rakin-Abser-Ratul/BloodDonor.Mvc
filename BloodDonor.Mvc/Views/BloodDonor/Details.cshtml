@* PSEUDOCODE / PLAN (detailed):
       1. Keep view model generic: @model object.
   2. If Model is null -> render "Item not found" and a Back link (styled like Edit).
   3. Reflect model runtime type to get public readable properties.
   4. Identify an identifier property (Id/ID/*Id*/Key) for Edit link route value.
   5. Provide helpers:
      - FormatValue(object?) -> format DateTime/DateTimeOffset/bool/null/others as string.
      - IsImageProperty(PropertyInfo, object?) -> decide if a property represents an image by:
          * name contains "photo","picture","image","avatar"
          * property type is byte[] or string
          * string value looks like data URI, URL, path or filename ending with image extension
      - ImageSrc(object?) -> produce a src string:
          * if byte[] -> data:image/png;base64,<base64>
          * if string that starts with "data:image" -> return it
          * if string that looks like base64 -> assume PNG and return data URI
          * if string that is URL/path -> return as-is
   6. Render a details layout:
      - Heading with type name.
      - A <dl> showing property names and values; for image properties render <img> thumbnail instead of textual value.
      - Use Bootstrap classes for layout and image styling (img-thumbnail, max-height).
   7. Actions:
      - "Edit" -> Html.ActionLink to Edit with id route value (primary button).
      - "Back to List" -> Html.ActionLink to Index with same styling as Edit (primary).
   8. Keep markup minimal and compatible with MVC Razor views.
*@

@model object

@using System.Reflection
@using System

@{
    var model = Model;
    if (model == null)
    {
        <text>
            <h2>Details</h2>
            <div class="alert alert-warning">Item not found.</div>
            @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-primary" })
        </text>
        return;
    }

    var type = model.GetType();
    var displayName = type.Name;
    var props = type.GetProperties(BindingFlags.Public | BindingFlags.Instance)
                    .Where(p => p.CanRead)
                    .OrderBy(p => p.Name)
                    .ToArray();

    // find likely id property
    var idProp = props.FirstOrDefault(p => string.Equals(p.Name, "Id", StringComparison.OrdinalIgnoreCase))
                 ?? props.FirstOrDefault(p => string.Equals(p.Name, "ID", StringComparison.OrdinalIgnoreCase))
                 ?? props.FirstOrDefault(p => p.Name.IndexOf("Id", StringComparison.OrdinalIgnoreCase) >= 0)
                 ?? props.FirstOrDefault(p => string.Equals(p.Name, "Key", StringComparison.OrdinalIgnoreCase));

    object? idValue = idProp != null ? idProp.GetValue(model) : null;

    string FormatValue(object? value)
    {
        if (value == null) return "—";
        if (value is DateTime dt) return dt.ToString("yyyy-MM-dd HH:mm");
        if (value is DateTimeOffset dto) return dto.ToString("yyyy-MM-dd HH:mm");
        if (value is bool b) return b ? "Yes" : "No";
        return value.ToString() ?? "—";
    }

    bool LooksLikeBase64(string s)
    {
        // Quick heuristic: length multiple of 4 and contains base64 characters
        s = s.Trim();
        if (s.Length % 4 != 0 || s.Length == 0) return false;
        foreach (var ch in s)
        {
            if (!(char.IsLetterOrDigit(ch) || ch == '+' || ch == '/' || ch == '=' || char.IsWhiteSpace(ch))) return false;
        }
        try
        {
            Convert.FromBase64String(s);
            return true;
        }
        catch { return false; }
    }

    bool IsImageProperty(PropertyInfo p, object? value)
    {
        var name = p.Name.ToLowerInvariant();
        if (name.Contains("photo") || name.Contains("picture") || name.Contains("image") || name.Contains("avatar")) return true;
        var t = p.PropertyType;
        if (t == typeof(byte[])) return true;
        if (t == typeof(string) && value is string s && !string.IsNullOrWhiteSpace(s))
        {
            var sl = s.Trim();
            if (sl.StartsWith("data:image", StringComparison.OrdinalIgnoreCase)) return true;
            if (sl.StartsWith("http", StringComparison.OrdinalIgnoreCase) || sl.StartsWith("/")) return true;
            var ext = sl.Length >= 4 ? sl.Substring(Math.Max(0, sl.Length - 4)).ToLowerInvariant() : sl.ToLowerInvariant();
            if (sl.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) ||
                sl.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase) ||
                sl.EndsWith(".png", StringComparison.OrdinalIgnoreCase) ||
                sl.EndsWith(".gif", StringComparison.OrdinalIgnoreCase) ||
                sl.EndsWith(".bmp", StringComparison.OrdinalIgnoreCase)) return true;
            if (LooksLikeBase64(sl)) return true;
        }
        return false;
    }

    string? ImageSrc(object? value)
    {
        if (value == null) return null;
        if (value is byte[] bytes && bytes.Length > 0)
        {
            var base64 = Convert.ToBase64String(bytes);
            return $"data:image/png;base64,{base64}";
        }
        if (value is string s)
        {
            var sl = s.Trim();
            if (sl.StartsWith("data:image", StringComparison.OrdinalIgnoreCase)) return sl;
            if (sl.StartsWith("http", StringComparison.OrdinalIgnoreCase) || sl.StartsWith("/")) return sl;
            if (LooksLikeBase64(sl)) return $"data:image/png;base64,{sl}";
            return sl; // fallback (could be filename)
        }
        return null;
    }
}

<h2>Details - @displayName</h2>

<div class="card">
    <div class="card-body">
        <dl class="row">
            @foreach (var p in props)
            {
                var val = p.GetValue(model);
                if (IsImageProperty(p, val))
                {
                    var src = ImageSrc(val);
                    <dt class="col-sm-3">@p.Name</dt>
                    <dd class="col-sm-9">
                        @if (!string.IsNullOrEmpty(src))
                        {
                            <img src="@src" alt="@p.Name" class="img-thumbnail" style="max-height:150px; max-width:320px;"/>
                        }
                        else
                        {
                            @FormatValue(val)
                        }
                    </dd>
                }
                else
                {
                    <dt class="col-sm-3">@p.Name</dt>
                    <dd class="col-sm-9">@FormatValue(val)</dd>
                }
            }
        </dl>

        <div class="mt-3">
            @if (idValue != null)
            {
                @Html.ActionLink("Edit", "Edit", new { id = idValue }, new { @class = "btn btn-primary" })
            }
            else
            {
                <button class="btn btn-primary" disabled="disabled">Edit</button>
            }
            @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-primary " })
        </div>
    </div>
</div>